# Nginx Configuration for Boganto Blog Backend
# Place this in: /etc/nginx/sites-available/boganto-backend

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name boganto.com www.boganto.com;
    
    location / {
        return 301 https://$server_name$request_uri;
    }
    
    # Allow Let's Encrypt verification
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

# Main HTTPS server block
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name boganto.com www.boganto.com;
    
    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/boganto.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/boganto.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Root directory
    root /var/www/boganto/backend;
    
    # Access and error logs
    access_log /var/log/nginx/boganto-access.log;
    error_log /var/log/nginx/boganto-error.log;
    
    # Performance settings
    client_max_body_size 5M;
    gzip on;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
    gzip_min_length 1000;
    
    # Cache settings
    expires 30d;
    add_header Cache-Control "public, immutable";
    
    # Index file
    index index.php;
    
    # Blog application location
    location /blog {
        alias /var/www/boganto/frontend/.next;
        try_files $uri $uri/ =404;
    }
    
    # API endpoints
    location /api {
        # Remove caching for API
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # All API requests go to server.php with query string preserved
        rewrite ^/api/(.*)$ /server.php?path=$1&$query_string last;
    }
    
    # Static files - uploads
    location /uploads {
        alias /var/www/boganto/uploads;
        expires 365d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # PHP Handler
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # Add environment variables from .env
        fastcgi_param DB_HOST $DB_HOST;
        fastcgi_param DB_USER $DB_USER;
        fastcgi_param DB_PASSWORD $DB_PASSWORD;
        fastcgi_param DB_NAME $DB_NAME;
        fastcgi_param APP_ENV $APP_ENV;
        fastcgi_param APP_URL $APP_URL;
        fastcgi_param ALLOWED_ORIGINS $ALLOWED_ORIGINS;
    }
    
    # Deny direct access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ \.env {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Default handler
    location / {
        try_files $uri $uri/ /server.php?$query_string;
    }
}
